package main

import (
	"bytes"
	"fmt"
	"os"
	"os/exec"
	"strings"
)

func gitDescribe(pattern string) string {
	revCmd := exec.Command(
		"git",
		"rev-list",
		"--tags",
		"--max-count=1",
	)
	var revOut bytes.Buffer
	revCmd.Stdout = &revOut
	if err := revCmd.Run(); err != nil {
		return ""
	}

	rev := strings.TrimSpace(revOut.String())
	if rev == "" {
		return ""
	}

	descCmd := exec.Command(
		"git",
		"describe",
		"--tags",
		"--abbrev=0",
		"--match",
		pattern,
		rev,
	)

	var out bytes.Buffer
	descCmd.Stdout = &out
	if err := descCmd.Run(); err != nil {
		return ""
	}
	return strings.TrimSpace(out.String())
}

func main() {
	dev := gitDescribe("dev-v*")
	if dev == "" {
		dev = "dev"
	}
	rel := gitDescribe("release-v*")
	if rel == "" {
		rel = "release"
	}

	content := fmt.Sprintf(`// Code generated by go:generate; DO NOT EDIT.
package conf

func init() {
    GitTagDev = %q
    GitTagProd = %q
}
`, dev, rel)

	// go:generate runs in internal/conf, write the file there
	outPath := "version_gen.go"
	if err := os.WriteFile(outPath, []byte(content), 0644); err != nil {
		fmt.Fprintf(os.Stderr, "failed to write %s: %v\n", outPath, err)
		os.Exit(1)
	}
}
