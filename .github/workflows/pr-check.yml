name: PR Checks

on:
  pull_request:
    branches: [main]

jobs:
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      go: ${{ steps.filter.outputs.go }}
      docs: ${{ steps.filter.outputs.docs }}
      sql: ${{ steps.filter.outputs.sql }}
      templ: ${{ steps.filter.outputs.templ }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            go:
              - '**/*.go'
              - 'go.mod'
              - 'go.sum'
            docs:
              - '**/*.md'
              - '**/*.yml'
              - '**/*.yaml'
            sql:
              - 'migrations/**/*.sql'
              - 'sqlc.yaml'
            templ:
              - '**/*.templ'

  whitespace:
    name: Trailing Whitespace
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: harupy/find-trailing-whitespace@master

  security:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: trufflesecurity/trufflehog@main
        with:
          base: ${{ github.event.repository.default_branch }}
          head: ${{ github.event.pull_request.head.sha }}

  commit-prefix:
    name: Commit Prefix
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Check commit messages
        run: |
          COMMITS=$(git log --format=%s ${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }})
          if echo "$COMMITS" | grep -vE '^(Feature|Maintenance|Deps|Toolings|Script|CICD|Config|Docs|Performance|Server|Web|Bugfix)(\(.+\))?: ' > /dev/null; then
            echo "::error::Commit messages must follow conventional commits format (e.g., 'Feature: message', 'Bugfix: message')"
            echo "Invalid commits:"
            echo "$COMMITS" | grep -vE '^(Feature|Maintenance|Deps|Toolings|Script|CICD|Config|Docs|Performance|Server|Web|Bugfix)(\(.+\))?: '
            exit 1
          fi

  vuln:
    name: Vulnerability Scan
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.go == 'true'
    steps:
      - uses: actions/checkout@v4
      - uses: golang/vulncheck-action@v1
        with:
          packages: ./...

  gensql:
    name: Generate SQL
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.sql == 'true'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: stable
      - run: go install github.com/magefile/mage@latest
      - run: mage gensql

  gentempl:
    name: Generate Templ
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.templ == 'true'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: stable
      - run: go install github.com/magefile/mage@latest
      - name: Install tailwindcss
        run: |
          curl -LO https://github.com/tailwindlabs/tailwindcss/releases/latest/download/tailwindcss-linux-x64
          chmod +x tailwindcss-linux-x64
          mv tailwindcss-linux-x64 tailwindcss
      - run: mage gentempl

  build:
    name: Build
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.go == 'true' && needs.changes.outputs.docs != 'true'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: stable
      - run: go install github.com/magefile/mage@latest
      - run: mage build

  lint:
    name: Lint
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.go == 'true' && needs.changes.outputs.docs != 'true'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: stable
      - uses: golangci/golangci-lint-action@v9
        with:
          version: latest
          args: --config=${{ github.workspace }}/.golangci.yml
